# Домашнее задание №1

- ФИО: Миловидов Святослав Александрович
- Предмет: обработка и генерация изображений
- Задача: детекция объектов
- Датасет: [кастомный](https://drive.google.com/drive/folders/1322IUASpXxhjv1__vt7Ujj-NTvMBT9oQ?usp=drive_link)
- модель: Yolo v8

## Краткое описание

- Необходимо создавать bbox на фотографиях, где есть сигарета. Сигареты могут быть как обычные, так и электронные. Дполнительно необходимо реализовать детекцию на видео.
- Стек: `ultralytics`, `matplotlib`, `numpy`, `opencv-python`, `torch-vision`

## Описание исходны данных

Формирование тренировоного датасета производилось руками (хотя можно было соорудить парсер).

- Количество фотографий в тренировочном датасете в первой версии - 100. Во второй версии - 200 изображений.
- Тестовый датасет содержит 180 фотографий

Тестовый датасет был получен от компании, поэтому вышло, что количество фотографий в нем превосходит тренировочный. Пример фотографии из тестового датасета ниже:

<img src="readme_imgs\sample_raw_data.jpg" swidth="200" height="300">

## Создание датасета

Для разметки данных использовалась `Roboflow`. Данные размечены под формат YOLO (v8). Фотографии были прмведены к размеру 640\*640.

Ну, здравствуй...

<img src="readme_imgs\sample_ready_data_no_resize.jpg" swidth="300" height="300">
<img src="readme_imgs\sample_ready_data.png" swidth="200" height="300">


## Обучение модели

В качетсве модели была выбрана `YOLOv8n`. [0ссновные характеристики моделей](https://docs.ultralytics.com/models/yolov8/#supported-modes).

Для оценки результата рассмотрим PR-кривую.

<img src="readme_imgs\PR_curve.png" swidth="200" height="300">

Пример дектции изображения:

<img src="readme_imgs\test_img.jpg" swidth="200" height="300">

Модель может выделять искомые объекты, но с небольшой увернностью. Что можно сделать, чтобы увеличит качество:

- увеличить объем тренировочных данных
- провести более тонкую настройку параметров модели (например, добавить sheduler)
- аугмментировать данные
- использовать предобученную модель

После увеличения тренировочного датасета на 100 фотографий видим хороший прирост в качестве

<img src="readme_imgs\PR_curve_75.png" swidth="200" height="300">

Пример дектции изображения:

<img src="readme_imgs\test_img_75.jpg" swidth="200" height="300">


## Обработка видео

Для работы с видео остаётс схожий принцип. Видео делится на кадры и каждый кадр подаётся на предсказание модели. Полученный результат записывается.

Модель детектирует объекты, но есть недостаток точности. Иногда появляются ложные предсказания на объектах схожей формы, поэтому требуется продолжить повышать качество модели.

Фрагмент полученной обработки с помощью модели, обученной на 100 изображениях:

<img src="readme_imgs\ready_video.gif" swidth="200" height="300">

Фрагмент полученной обработки с помощью модели, обученной на 200 изображениях:

<img src="readme_imgs\redy_video_75.gif" swidth="200" height="300">

Во втором варианте ложных детекций меньше.

p.s. небольшое набюдение: если сигарета расположена в профиль, то модель срабатывает лучше, чем если сигарета смотрит прямо (*в камеру). Добавление новых изображений в датасет должно решить проблему.


## Создания сервиса

Код сервиса содержится в директории `src`. Описание имеющихся модулей:

- **const.py**: содержит константные значения (пути к файлам)
- **loader.py**: содержит экземпляр класса детектора
- **get_prediction.py**: содержит описание класса детектора
- **detector.py**: точка входа в программу

Класс `CigaretteDetector` из модуля **get_prediction.py** является главным классом и содержит следующие методы:

- `get_predict_for_img()` - создает bbox на изображениях
- `get_predict_for_move()` - создает bbox на видео

В директории **models** расположен файл с весами модели.

В директории **test_data** находятся изображение и видео для тестирования программы.

Для запуска сервиса необходимо ввести команду в терминал в следующем формате:

`python3 detector.pt --source путь_к_файлу`

В результате, в текущей директории будет создан файл с bbox.
